set -euo pipefail
cp -v .replit .replit.bak.$(date +%s)

cat > .replit <<'REPLIT'
modules = ["nodejs-20"]

[nix]
channel = "stable-25_05"
packages = ["gh","nano","unzip"]

# ðŸ‘‰ Run ONLY Next.js (binds to Replit's port via our wrapper)
[workflows]
run = "npm run dev"

# Expose Next dev (internal 3000) on the public URL
[[ports]]
localPort = 3000
externalPort = 80
REPLIT

# optional: keep wrapper we created earlier
mkdir -p scripts
cat > scripts/dev.sh <<'SH'
#!/usr/bin/env bash
set -euo pipefail
PORT_VAL="${PORT:-3000}"
exec npx next dev -H 0.0.0.0 -p "$PORT_VAL"
SH
chmod +x scripts/dev.sh

# Ensure package.json uses wrapper
node -e 'const fs=require("fs");const p=JSON.parse(fs.readFileSync("package.json","utf8"));p.scripts=p.scripts||{};p.scripts.dev="bash scripts/dev.sh";fs.writeFileSync("package.json",JSON.stringify(p,null,2));console.log("scripts.dev set -> bash scripts/dev.sh")'
