#!/bin/bash
set -euo pipefail

# ==============================================================================
# SmartFlow Systems - Security Penetration Testing Suite
# ==============================================================================
# Tests the security fixes implemented in PR #153
# Validates protection against CodeQL-identified vulnerabilities
#
# Usage:
#   ./scripts/security-pentest.sh [base-url]
#
# Default: http://localhost:3000

BASE_URL="${1:-http://localhost:3000}"
ORCHESTRATOR_URL="${2:-http://localhost:5001}"
PASS_COUNT=0
FAIL_COUNT=0
SKIP_COUNT=0

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ”’ SmartFlow Security Penetration Testing Suite"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Target: $BASE_URL"
echo "Orchestrator: $ORCHESTRATOR_URL"
echo "Started: $(date)"
echo ""

# Test result tracking
pass() {
  echo -e "${GREEN}âœ… PASS${NC}: $1"
  ((PASS_COUNT++))
}

fail() {
  echo -e "${RED}âŒ FAIL${NC}: $1"
  ((FAIL_COUNT++))
}

skip() {
  echo -e "${YELLOW}âŠ˜ SKIP${NC}: $1"
  ((SKIP_COUNT++))
}

info() {
  echo -e "${BLUE}â„¹ï¸  INFO${NC}: $1"
}

# ==============================================================================
# TEST CATEGORY 1: ReDoS Protection (CWE-1333)
# ==============================================================================
echo "â•â•â• Test Category 1: ReDoS Protection â•â•â•"

# Test 1.1: Email validation with malicious input
echo ""
info "Test 1.1: Email validation ReDoS protection"
START_TIME=$(date +%s.%N)

RESPONSE=$(curl -s -X POST "$BASE_URL/api/leads" \
  -H "Content-Type: application/json" \
  -d '{
    "firstName": "Test",
    "lastName": "User",
    "email": "a@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@example.com"
  }' 2>&1 || echo "error")

END_TIME=$(date +%s.%N)
ELAPSED=$(echo "$END_TIME - $START_TIME" | bc)

# Should complete in under 1 second (ReDoS would hang)
if (( $(echo "$ELAPSED < 1.0" | bc -l) )); then
  if echo "$RESPONSE" | grep -q "Invalid email format"; then
    pass "Email validation rejects malformed input quickly (${ELAPSED}s)"
  else
    fail "Email validation didn't reject malicious input"
  fi
else
  fail "Email validation took too long (${ELAPSED}s) - possible ReDoS"
fi

# Test 1.2: Variable resolution ReDoS
echo ""
info "Test 1.2: Variable resolution ReDoS protection"

# Test with deeply nested braces (would cause catastrophic backtracking)
WORKFLOW_DATA='{
  "id": "redos-test",
  "steps": [{
    "action": "set-context",
    "input": {
      "test": "${{{{{{{{{{{{{{{{{var}}}}}}}}}}}}}}}}}"
    }
  }]
}'

RESPONSE=$(curl -s -X POST "$ORCHESTRATOR_URL/api/workflows" \
  -H "Content-Type: application/json" \
  -d "$WORKFLOW_DATA" 2>&1 || echo "error")

if echo "$RESPONSE" | grep -qE "success|Invalid"; then
  pass "Variable resolution handles malicious input safely"
else
  skip "Orchestrator not running or endpoint not available"
fi

# ==============================================================================
# TEST CATEGORY 2: Prototype Pollution (CWE-1321)
# ==============================================================================
echo ""
echo "â•â•â• Test Category 2: Prototype Pollution â•â•â•"

# Test 2.1: __proto__ injection attempt
echo ""
info "Test 2.1: __proto__ pollution protection"

RESPONSE=$(curl -s -X POST "$ORCHESTRATOR_URL/api/workflows" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "proto-test",
    "__proto__": {"isAdmin": true},
    "steps": []
  }' 2>&1 || echo "error")

if echo "$RESPONSE" | grep -q "Forbidden property"; then
  pass "__proto__ injection blocked"
elif echo "$RESPONSE" | grep -q "error"; then
  skip "Orchestrator not running"
else
  fail "__proto__ injection not blocked - CRITICAL VULNERABILITY"
fi

# Test 2.2: constructor injection attempt
echo ""
info "Test 2.2: constructor pollution protection"

RESPONSE=$(curl -s -X POST "$ORCHESTRATOR_URL/api/workflows" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "constructor-test",
    "steps": [{
      "action": "set-context",
      "input": {
        "constructor": "malicious"
      }
    }]
  }' 2>&1 || echo "error")

if echo "$RESPONSE" | grep -q "Forbidden property"; then
  pass "constructor injection blocked"
elif echo "$RESPONSE" | grep -q "error"; then
  skip "Orchestrator not running"
else
  fail "constructor injection not blocked"
fi

# Test 2.3: prototype injection attempt
echo ""
info "Test 2.3: prototype pollution protection"

RESPONSE=$(curl -s -X POST "$ORCHESTRATOR_URL/api/workflows" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "prototype-test",
    "steps": [{
      "action": "set-context",
      "input": {
        "prototype": {"admin": true}
      }
    }]
  }' 2>&1 || echo "error")

if echo "$RESPONSE" | grep -q "Forbidden property"; then
  pass "prototype injection blocked"
elif echo "$RESPONSE" | grep -q "error"; then
  skip "Orchestrator not running"
else
  fail "prototype injection not blocked"
fi

# ==============================================================================
# TEST CATEGORY 3: Rate Limiting (CWE-770)
# ==============================================================================
echo ""
echo "â•â•â• Test Category 3: Rate Limiting â•â•â•"

# Test 3.1: Dashboard rate limiting
echo ""
info "Test 3.1: Dashboard endpoint rate limiting (testing 15 requests)"

BLOCKED=0
for i in {1..15}; do
  STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$ORCHESTRATOR_URL/" 2>&1 || echo "000")
  if [[ "$STATUS" == "429" ]]; then
    ((BLOCKED++))
  fi
done

if [[ $BLOCKED -eq 0 ]]; then
  pass "Rate limiting configured (15 requests within limit)"
else
  info "Rate limiter activated after requests (this is expected behavior)"
  pass "Rate limiting working correctly"
fi

# Test 3.2: API rate limiting stress test
echo ""
info "Test 3.2: Leads API rate limiting (requires fileSystemLimiter)"

# Send multiple requests rapidly
SUCCESS=0
RATE_LIMITED=0

for i in {1..10}; do
  STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$BASE_URL/api/leads" \
    -H "Content-Type: application/json" \
    -d "{\"firstName\":\"Test\",\"lastName\":\"User$i\",\"email\":\"test$i@example.com\"}" \
    2>&1 || echo "000")

  if [[ "$STATUS" == "200" ]] || [[ "$STATUS" == "400" ]]; then
    ((SUCCESS++))
  elif [[ "$STATUS" == "429" ]]; then
    ((RATE_LIMITED++))
  fi
done

if [[ $SUCCESS -gt 0 ]]; then
  pass "API accepts legitimate requests"
fi

# ==============================================================================
# TEST CATEGORY 4: Resource Exhaustion (CWE-400)
# ==============================================================================
echo ""
echo "â•â•â• Test Category 4: Resource Exhaustion â•â•â•"

# Test 4.1: Wait action duration limit
echo ""
info "Test 4.1: Wait action duration capping"

WORKFLOW_DATA='{
  "id": "wait-test",
  "steps": [{
    "action": "wait",
    "input": {
      "duration": 999999999
    }
  }]
}'

START_TIME=$(date +%s)
RESPONSE=$(timeout 65 curl -s -X POST "$ORCHESTRATOR_URL/api/workflows/execute" \
  -H "Content-Type: application/json" \
  -d "$WORKFLOW_DATA" 2>&1 || echo "timeout")
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))

if [[ $ELAPSED -lt 65 ]]; then
  pass "Wait action capped to 60 seconds (took ${ELAPSED}s)"
else
  fail "Wait action exceeded 60 second limit"
fi

# ==============================================================================
# TEST CATEGORY 5: Dynamic Method Call Validation (CWE-913)
# ==============================================================================
echo ""
echo "â•â•â• Test Category 5: Dynamic Method Call Validation â•â•â•"

# Test 5.1: Unauthorized action
echo ""
info "Test 5.1: Unauthorized action rejection"

WORKFLOW_DATA='{
  "id": "action-test",
  "steps": [{
    "action": "eval",
    "input": {
      "code": "console.log(process.env)"
    }
  }]
}'

RESPONSE=$(curl -s -X POST "$ORCHESTRATOR_URL/api/workflows/execute" \
  -H "Content-Type: application/json" \
  -d "$WORKFLOW_DATA" 2>&1 || echo "error")

if echo "$RESPONSE" | grep -q "Unauthorized action"; then
  pass "Unauthorized action 'eval' rejected"
elif echo "$RESPONSE" | grep -q "error"; then
  skip "Orchestrator not running"
else
  fail "Unauthorized action not blocked - CRITICAL VULNERABILITY"
fi

# Test 5.2: Whitelisted action
echo ""
info "Test 5.2: Whitelisted action acceptance"

WORKFLOW_DATA='{
  "id": "log-test",
  "steps": [{
    "action": "log",
    "input": {
      "message": "Test message"
    }
  }]
}'

RESPONSE=$(curl -s -X POST "$ORCHESTRATOR_URL/api/workflows/execute" \
  -H "Content-Type: application/json" \
  -d "$WORKFLOW_DATA" 2>&1 || echo "error")

if echo "$RESPONSE" | grep -qE "success|logged"; then
  pass "Whitelisted action 'log' accepted"
elif echo "$RESPONSE" | grep -q "error"; then
  skip "Orchestrator not running"
else
  fail "Whitelisted action rejected incorrectly"
fi

# ==============================================================================
# TEST CATEGORY 6: Path Traversal (CWE-22)
# ==============================================================================
echo ""
echo "â•â•â• Test Category 6: Path Traversal â•â•â•"

# Test 6.1: Directory traversal in workflow ID
echo ""
info "Test 6.1: Path traversal protection in workflow ID"

WORKFLOW_DATA='{
  "id": "../../../etc/passwd",
  "steps": []
}'

RESPONSE=$(curl -s -X POST "$ORCHESTRATOR_URL/api/workflows" \
  -H "Content-Type: application/json" \
  -d "$WORKFLOW_DATA" 2>&1 || echo "error")

if echo "$RESPONSE" | grep -qE "Invalid workflow id format|path traversal"; then
  pass "Path traversal attempt blocked"
elif echo "$RESPONSE" | grep -q "error"; then
  skip "Orchestrator not running"
else
  fail "Path traversal not blocked - CRITICAL VULNERABILITY"
fi

# Test 6.2: Path traversal with encoded characters
echo ""
info "Test 6.2: Encoded path traversal protection"

WORKFLOW_DATA='{
  "id": "..%2F..%2F..%2Fetc%2Fpasswd",
  "steps": []
}'

RESPONSE=$(curl -s -X POST "$ORCHESTRATOR_URL/api/workflows" \
  -H "Content-Type: application/json" \
  -d "$WORKFLOW_DATA" 2>&1 || echo "error")

if echo "$RESPONSE" | grep -qE "Invalid workflow id format"; then
  pass "Encoded path traversal blocked"
elif echo "$RESPONSE" | grep -q "error"; then
  skip "Orchestrator not running"
else
  info "Check workflow sanitization for encoded characters"
fi

# ==============================================================================
# TEST CATEGORY 7: Log Injection (CWE-117)
# ==============================================================================
echo ""
echo "â•â•â• Test Category 7: Log Injection â•â•â•"

# Test 7.1: Newline injection in email
echo ""
info "Test 7.1: Log injection via email field"

MALICIOUS_EMAIL="test@example.com\n[FAKE] Admin logged in\nmalicious@evil.com"

RESPONSE=$(curl -s -X POST "$BASE_URL/api/leads" \
  -H "Content-Type: application/json" \
  -d "{
    \"firstName\": \"Test\",
    \"lastName\": \"User\",
    \"email\": \"$MALICIOUS_EMAIL\"
  }" 2>&1 || echo "error")

if echo "$RESPONSE" | grep -q "Invalid email format"; then
  pass "Log injection via email rejected (invalid format)"
else
  info "Check logs for sanitization of user input"
fi

# Test 7.2: ANSI escape injection
echo ""
info "Test 7.2: ANSI escape code injection"

RESPONSE=$(curl -s -X POST "$ORCHESTRATOR_URL/api/workflows/execute" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "ansi-test",
    "steps": [{
      "action": "log",
      "input": {
        "message": "\u001b[31mFAKE ERROR\u001b[0m"
      }
    }]
  }' 2>&1 || echo "error")

if echo "$RESPONSE" | grep -qE "success|error"; then
  info "Check application logs for sanitized output (should strip ANSI codes)"
else
  skip "Orchestrator not running"
fi

# ==============================================================================
# TEST CATEGORY 8: Workflow Validation (CWE-73)
# ==============================================================================
echo ""
echo "â•â•â• Test Category 8: Workflow Validation â•â•â•"

# Test 8.1: Oversized workflow
echo ""
info "Test 8.1: Workflow size limit enforcement"

# Create a workflow with many steps
BIG_WORKFLOW='{"id":"size-test","steps":['
for i in {1..150}; do
  BIG_WORKFLOW+="{\"action\":\"log\",\"input\":{\"message\":\"step$i\"}},"
done
BIG_WORKFLOW+='{"action":"log","input":{"message":"end"}}]}'

RESPONSE=$(curl -s -X POST "$ORCHESTRATOR_URL/api/workflows" \
  -H "Content-Type: application/json" \
  -d "$BIG_WORKFLOW" 2>&1 || echo "error")

if echo "$RESPONSE" | grep -q "Too many workflow steps"; then
  pass "Oversized workflow rejected (>100 steps)"
elif echo "$RESPONSE" | grep -q "error"; then
  skip "Orchestrator not running"
else
  fail "Oversized workflow accepted - DoS risk"
fi

# Test 8.2: Invalid workflow structure
echo ""
info "Test 8.2: Invalid workflow structure rejection"

RESPONSE=$(curl -s -X POST "$ORCHESTRATOR_URL/api/workflows" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "invalid-test",
    "steps": [
      {
        "action": "log",
        "agent": "test-agent",
        "input": {}
      }
    ]
  }' 2>&1 || echo "error")

if echo "$RESPONSE" | grep -q "exactly one of"; then
  pass "Invalid workflow structure rejected"
elif echo "$RESPONSE" | grep -q "error"; then
  skip "Orchestrator not running"
else
  fail "Invalid workflow structure accepted"
fi

# ==============================================================================
# SUMMARY REPORT
# ==============================================================================
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“Š Penetration Testing Summary"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Completed: $(date)"
echo ""
echo -e "${GREEN}âœ… Passed:${NC}  $PASS_COUNT tests"
echo -e "${RED}âŒ Failed:${NC}  $FAIL_COUNT tests"
echo -e "${YELLOW}âŠ˜ Skipped:${NC} $SKIP_COUNT tests"
echo ""

TOTAL_TESTS=$((PASS_COUNT + FAIL_COUNT + SKIP_COUNT))
if [[ $TOTAL_TESTS -gt 0 ]]; then
  SUCCESS_RATE=$(echo "scale=1; $PASS_COUNT * 100 / ($PASS_COUNT + $FAIL_COUNT)" | bc)
  echo "Success Rate: ${SUCCESS_RATE}% (excluding skipped)"
fi

echo ""

if [[ $FAIL_COUNT -eq 0 ]]; then
  echo -e "${GREEN}âœ… ALL TESTS PASSED${NC}"
  echo "The security fixes are working correctly."
  exit 0
else
  echo -e "${RED}âŒ TESTS FAILED${NC}"
  echo "Critical security vulnerabilities detected. Review failures above."
  exit 1
fi
